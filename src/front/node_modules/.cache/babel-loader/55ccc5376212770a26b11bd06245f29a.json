{"ast":null,"code":"/*\n * Copyright (c) 2018, 2021, Oracle and/or its affiliates.\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License, version 2.0, as\n * published by the Free Software Foundation.\n *\n * This program is also distributed with certain software (including\n * but not limited to OpenSSL) that is licensed under separate terms,\n * as designated in a particular file or component or in included license\n * documentation.  The authors of MySQL hereby grant you an\n * additional permission to link the program and your derivative works\n * with the separately licensed software that they have included with\n * MySQL.\n *\n * Without limiting anything contained in the foregoing, this file,\n * which is part of MySQL Connector/Node.js, is also subject to the\n * Universal FOSS Exception, version 1.0, a copy of which can be found at\n * http://oss.oracle.com/licenses/universal-foss-exception.\n *\n * This program is distributed in the hope that it will be useful, but\n * WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * See the GNU General Public License, version 2.0, for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software Foundation, Inc.,\n * 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA\n */\n'use strict';\n\nconst authPlugin = require('./AuthPlugin');\n\nconst errors = require('../constants/errors');\n\nconst util = require('util');\n\nconst {\n  sha256,\n  xor\n} = require('../crypto');\n\nconst Name = 'SHA256_MEMORY';\n/**\n * SHA256MemoryAuth factory.\n * @private\n * @alias SHA256MemoryAuth\n * @param {Object} state - plugin properties\n * @returns {SHA256MemoryAuth} A plugin instance.\n */\n\nfunction SHA256MemoryAuth(state) {\n  state = Object.assign({\n    algorithm: 'sha256',\n    hashSize: 32,\n    nonceSize: 20\n  }, state);\n  return Object.assign({}, authPlugin(state), {\n    /**\n     * Generate the payload for the first authentication step.\n     * @function\n     * @name module:SHA256MemoryAuth#getInitialAuthData\n     * @returns {undefined}\n     */\n    getInitialAuthData() {},\n\n    /**\n     * Retrieve the name of the authentication mechanism (client plugin).\n     * @function\n     * @name module:SHA256MemoryAuth#getName\n     * @returns {string} 'SHA256_MEMORY'\n     */\n    getName() {\n      return Name;\n    },\n\n    /**\n     * Generate the payload for the second authentication step.\n     * @function\n     * @name module:SHA256MemoryAuth#getNextAuthData\n     * @param {Buffer} nonce - nonce returned by the server in the first step\n     * @returns {Buffer} A Node.js buffer with a hexadecimal value in the format of \"[SCHEMA]\\0USER\\0SCRAMBLE\".\n     */\n    getNextAuthData(nonce) {\n      if (nonce.length !== state.nonceSize) {\n        throw new Error(util.format(errors.MESSAGES.ER_DEVAPI_AUTH_NONCE_MISMATCH, state.nonceSize, nonce.length));\n      }\n\n      const schema = this.getSchema();\n      const user = this.getUser();\n      const password = this.getPassword(); // it does not matter if the password is empty or not, since the hash is an hexadecimal string,\n      // we should accomodate enough space for each character (even for \"zeroed\" bytes, since the\n      // scramble is mandatory)\n\n      const size = schema.length + user.length + state.hashSize * 2 + 3; // We want the buffer to be zero-filled by default, so we should\n      // use Buffer.alloc().\n\n      const authData = Buffer.alloc(size);\n      authData.write(schema);\n      authData.write(user, schema.length + 1); // authData = \"[SCHEMA]\\0USER\\0SCRAMBLE\"\n\n      const scramble = xor(sha256(sha256(sha256(password)), nonce), sha256(password));\n      authData.write(scramble.toString('hex'), schema.length + user.length + 2);\n      return authData;\n    }\n\n  });\n}\n\nSHA256MemoryAuth.Name = Name;\nmodule.exports = SHA256MemoryAuth;","map":{"version":3,"sources":["/home/ad/Bureau/infof308/src/node_modules/@mysql/xdevapi/lib/Authentication/SHA256MemoryAuth.js"],"names":["authPlugin","require","errors","util","sha256","xor","Name","SHA256MemoryAuth","state","Object","assign","algorithm","hashSize","nonceSize","getInitialAuthData","getName","getNextAuthData","nonce","length","Error","format","MESSAGES","ER_DEVAPI_AUTH_NONCE_MISMATCH","schema","getSchema","user","getUser","password","getPassword","size","authData","Buffer","alloc","write","scramble","toString","module","exports"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;AAEA,MAAMA,UAAU,GAAGC,OAAO,CAAC,cAAD,CAA1B;;AACA,MAAMC,MAAM,GAAGD,OAAO,CAAC,qBAAD,CAAtB;;AACA,MAAME,IAAI,GAAGF,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;AAAEG,EAAAA,MAAF;AAAUC,EAAAA;AAAV,IAAkBJ,OAAO,CAAC,WAAD,CAA/B;;AAEA,MAAMK,IAAI,GAAG,eAAb;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,SAASC,gBAAT,CAA2BC,KAA3B,EAAkC;AAC9BA,EAAAA,KAAK,GAAGC,MAAM,CAACC,MAAP,CAAc;AAAEC,IAAAA,SAAS,EAAE,QAAb;AAAuBC,IAAAA,QAAQ,EAAE,EAAjC;AAAqCC,IAAAA,SAAS,EAAE;AAAhD,GAAd,EAAoEL,KAApE,CAAR;AAEA,SAAOC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBV,UAAU,CAACQ,KAAD,CAA5B,EAAqC;AACxC;AACR;AACA;AACA;AACA;AACA;AACQM,IAAAA,kBAAkB,GAAI,CAAE,CAPgB;;AASxC;AACR;AACA;AACA;AACA;AACA;AACQC,IAAAA,OAAO,GAAI;AACP,aAAOT,IAAP;AACH,KAjBuC;;AAmBxC;AACR;AACA;AACA;AACA;AACA;AACA;AACQU,IAAAA,eAAe,CAAEC,KAAF,EAAS;AACpB,UAAIA,KAAK,CAACC,MAAN,KAAiBV,KAAK,CAACK,SAA3B,EAAsC;AAClC,cAAM,IAAIM,KAAJ,CAAUhB,IAAI,CAACiB,MAAL,CAAYlB,MAAM,CAACmB,QAAP,CAAgBC,6BAA5B,EAA2Dd,KAAK,CAACK,SAAjE,EAA4EI,KAAK,CAACC,MAAlF,CAAV,CAAN;AACH;;AAED,YAAMK,MAAM,GAAG,KAAKC,SAAL,EAAf;AACA,YAAMC,IAAI,GAAG,KAAKC,OAAL,EAAb;AACA,YAAMC,QAAQ,GAAG,KAAKC,WAAL,EAAjB,CAPoB,CAQpB;AACA;AACA;;AACA,YAAMC,IAAI,GAAGN,MAAM,CAACL,MAAP,GAAgBO,IAAI,CAACP,MAArB,GAA8BV,KAAK,CAACI,QAAN,GAAiB,CAA/C,GAAmD,CAAhE,CAXoB,CAapB;AACA;;AACA,YAAMkB,QAAQ,GAAGC,MAAM,CAACC,KAAP,CAAaH,IAAb,CAAjB;AACAC,MAAAA,QAAQ,CAACG,KAAT,CAAeV,MAAf;AACAO,MAAAA,QAAQ,CAACG,KAAT,CAAeR,IAAf,EAAqBF,MAAM,CAACL,MAAP,GAAgB,CAArC,EAjBoB,CAmBpB;;AACA,YAAMgB,QAAQ,GAAG7B,GAAG,CAACD,MAAM,CAACA,MAAM,CAACA,MAAM,CAACuB,QAAD,CAAP,CAAP,EAA2BV,KAA3B,CAAP,EAA0Cb,MAAM,CAACuB,QAAD,CAAhD,CAApB;AACAG,MAAAA,QAAQ,CAACG,KAAT,CAAeC,QAAQ,CAACC,QAAT,CAAkB,KAAlB,CAAf,EAAyCZ,MAAM,CAACL,MAAP,GAAgBO,IAAI,CAACP,MAArB,GAA8B,CAAvE;AAEA,aAAOY,QAAP;AACH;;AAlDuC,GAArC,CAAP;AAoDH;;AAEDvB,gBAAgB,CAACD,IAAjB,GAAwBA,IAAxB;AAEA8B,MAAM,CAACC,OAAP,GAAiB9B,gBAAjB","sourcesContent":["/*\n * Copyright (c) 2018, 2021, Oracle and/or its affiliates.\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License, version 2.0, as\n * published by the Free Software Foundation.\n *\n * This program is also distributed with certain software (including\n * but not limited to OpenSSL) that is licensed under separate terms,\n * as designated in a particular file or component or in included license\n * documentation.  The authors of MySQL hereby grant you an\n * additional permission to link the program and your derivative works\n * with the separately licensed software that they have included with\n * MySQL.\n *\n * Without limiting anything contained in the foregoing, this file,\n * which is part of MySQL Connector/Node.js, is also subject to the\n * Universal FOSS Exception, version 1.0, a copy of which can be found at\n * http://oss.oracle.com/licenses/universal-foss-exception.\n *\n * This program is distributed in the hope that it will be useful, but\n * WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * See the GNU General Public License, version 2.0, for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software Foundation, Inc.,\n * 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA\n */\n\n'use strict';\n\nconst authPlugin = require('./AuthPlugin');\nconst errors = require('../constants/errors');\nconst util = require('util');\nconst { sha256, xor } = require('../crypto');\n\nconst Name = 'SHA256_MEMORY';\n\n/**\n * SHA256MemoryAuth factory.\n * @private\n * @alias SHA256MemoryAuth\n * @param {Object} state - plugin properties\n * @returns {SHA256MemoryAuth} A plugin instance.\n */\nfunction SHA256MemoryAuth (state) {\n    state = Object.assign({ algorithm: 'sha256', hashSize: 32, nonceSize: 20 }, state);\n\n    return Object.assign({}, authPlugin(state), {\n        /**\n         * Generate the payload for the first authentication step.\n         * @function\n         * @name module:SHA256MemoryAuth#getInitialAuthData\n         * @returns {undefined}\n         */\n        getInitialAuthData () {},\n\n        /**\n         * Retrieve the name of the authentication mechanism (client plugin).\n         * @function\n         * @name module:SHA256MemoryAuth#getName\n         * @returns {string} 'SHA256_MEMORY'\n         */\n        getName () {\n            return Name;\n        },\n\n        /**\n         * Generate the payload for the second authentication step.\n         * @function\n         * @name module:SHA256MemoryAuth#getNextAuthData\n         * @param {Buffer} nonce - nonce returned by the server in the first step\n         * @returns {Buffer} A Node.js buffer with a hexadecimal value in the format of \"[SCHEMA]\\0USER\\0SCRAMBLE\".\n         */\n        getNextAuthData (nonce) {\n            if (nonce.length !== state.nonceSize) {\n                throw new Error(util.format(errors.MESSAGES.ER_DEVAPI_AUTH_NONCE_MISMATCH, state.nonceSize, nonce.length));\n            }\n\n            const schema = this.getSchema();\n            const user = this.getUser();\n            const password = this.getPassword();\n            // it does not matter if the password is empty or not, since the hash is an hexadecimal string,\n            // we should accomodate enough space for each character (even for \"zeroed\" bytes, since the\n            // scramble is mandatory)\n            const size = schema.length + user.length + state.hashSize * 2 + 3;\n\n            // We want the buffer to be zero-filled by default, so we should\n            // use Buffer.alloc().\n            const authData = Buffer.alloc(size);\n            authData.write(schema);\n            authData.write(user, schema.length + 1);\n\n            // authData = \"[SCHEMA]\\0USER\\0SCRAMBLE\"\n            const scramble = xor(sha256(sha256(sha256(password)), nonce), sha256(password));\n            authData.write(scramble.toString('hex'), schema.length + user.length + 2);\n\n            return authData;\n        }\n    });\n}\n\nSHA256MemoryAuth.Name = Name;\n\nmodule.exports = SHA256MemoryAuth;\n"]},"metadata":{},"sourceType":"script"}